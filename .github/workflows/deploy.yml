name: Deploy para Produ√ß√£o

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validar secrets necess√°rios
      run: |
        if [ -z "${{ secrets.PROD_HOST }}" ]; then
          echo "::error::PROD_HOST secret n√£o configurado"
          exit 1
        fi
        if [ -z "${{ secrets.PROD_USER }}" ]; then
          echo "::error::PROD_USER secret n√£o configurado"
          exit 1
        fi
        if [ -z "${{ secrets.PROD_SSH_KEY }}" ]; then
          echo "::error::PROD_SSH_KEY secret n√£o configurado"
          exit 1
        fi
        echo "‚úÖ Todos os secrets necess√°rios est√£o configurados"

    - name: Deploy com SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        port: ${{ secrets.PROD_SSH_PORT || 22 }}
        script_stop: true
        script: |
          set -e
          echo "üöÄ Iniciando deploy em $(date)"
          cd /app/fluxo-caixa-api
          echo "üì• Atualizando c√≥digo..."
          git fetch --all
          git pull origin main
          echo "üê≥ Atualizando containers..."
          docker-compose pull
          docker-compose up -d --force-recreate
          echo "‚è≥ Aguardando containers iniciarem..."
          sleep 10
          echo "üíæ Executando migrations..."
          docker-compose exec -T api dotnet ef database update --project Store --startup-project FluxoCaixaApi || true
          echo "‚úÖ Deploy conclu√≠do em $(date)"

    - name: Verificar sa√∫de da aplica√ß√£o
      run: |
        echo "üè• Verificando sa√∫de da aplica√ß√£o..."
        for i in {1..5}; do
          if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.PROD_HOST }}/health | grep -q "200\|204"; then
            echo "‚úÖ Aplica√ß√£o est√° saud√°vel"
            exit 0
          fi
          echo "‚è≥ Tentativa $i/5 - Aguardando aplica√ß√£o ficar dispon√≠vel..."
          sleep 10
        done
        echo "‚ö†Ô∏è N√£o foi poss√≠vel verificar a sa√∫de da aplica√ß√£o"
        exit 0

    - name: Notificar sucesso
      if: success()
      run: |
        echo "‚úÖ Deploy realizado com sucesso!"
        echo "Tag: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"